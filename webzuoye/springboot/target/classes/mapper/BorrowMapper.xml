<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.BorrowMapper">
    <resultMap id="BaseResultMap" type="com.example.entity.Borrow">
        <id property="id" column="id"/>
        <result property="bookId" column="book_id"/>
        <result property="bookName" column="book_name"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="adminId" column="admin_id"/>
        <result property="adminName" column="admin_name"/>
        <result property="borrowTime" column="borrow_time"/>
        <result property="dueTime" column="due_time"/>
        <result property="returnTime" column="return_time"/>
        <result property="status" column="status"/>
        <result property="overdueDays" column="overdue_days"/>
        <result property="fine" column="fine"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO borrow (book_id, user_id, admin_id, borrow_time, due_time, status)
        VALUES (#{bookId}, #{userId}, #{adminId}, #{borrowTime}, #{dueTime}, #{status})
    </insert>

    <update id="updateById">
        UPDATE borrow
        <set>
            <if test="returnTime != null">return_time = #{returnTime},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="overdueDays != null">overdue_days = #{overdueDays},</if>
            <if test="fine != null">fine = #{fine},</if>
        </set>
        WHERE id = #{id}
    </update>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT b.*, bk.name as book_name, u.name as user_name, ut.name as admin_name
        FROM borrow b
                 LEFT JOIN book bk ON b.book_id = bk.id
                 LEFT JOIN user u ON b.user_id = u.id
                 LEFT JOIN userT ut ON b.admin_id = ut.id
        WHERE b.id = #{id}
    </select>

    <select id="selectAll" resultMap="BaseResultMap">
        SELECT b.*, bk.name as book_name, u.name as user_name, ut.name as admin_name
        FROM borrow b
        LEFT JOIN book bk ON b.book_id = bk.id
        LEFT JOIN user u ON b.user_id = u.id
        LEFT JOIN userT ut ON b.admin_id = ut.id
        <where>
            <if test="bookName != null and bookName != ''">AND bk.name LIKE CONCAT('%', #{bookName}, '%')</if>
            <if test="userName != null and userName != ''">AND u.name LIKE CONCAT('%', #{userName}, '%')</if>
            <if test="status != null and status != ''">AND b.status = #{status}</if>
        </where>
        ORDER BY b.borrow_time DESC
    </select>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT b.*, bk.name as book_name, u.name as user_name, ut.name as admin_name
        FROM borrow b
                 LEFT JOIN book bk ON b.book_id = bk.id
                 LEFT JOIN user u ON b.user_id = u.id
                 LEFT JOIN userT ut ON b.admin_id = ut.id
        WHERE b.user_id = #{userId}
        ORDER BY b.borrow_time DESC
    </select>
</mapper>