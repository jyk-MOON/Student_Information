{"ast":null,"code":"export default {\n  name: \"BorrowRecord\",\n  data() {\n    return {\n      // 表格数据\n      tableData: [],\n      loading: false,\n      pageNum: 1,\n      pageSize: 10,\n      total: 0,\n      // 搜索条件\n      searchBookName: '',\n      searchStudent: '',\n      searchStatus: '',\n      searchDateRange: [],\n      // 选中项\n      selectedIds: [],\n      // 对话框\n      detailDialogVisible: false,\n      currentRecord: null,\n      // 当前登录管理员信息\n      currentAdmin: JSON.parse(localStorage.getItem('xm-user') || '{}')\n    };\n  },\n  created() {\n    // 页面加载时，获取借阅记录列表\n    this.load(1);\n  },\n  methods: {\n    // 加载借阅记录列表\n    async load(pageNum) {\n      if (pageNum) this.pageNum = pageNum;\n      this.loading = true;\n\n      // 构建查询参数\n      const params = {\n        pageNum: this.pageNum,\n        pageSize: this.pageSize\n      };\n\n      // 添加可选查询条件\n      if (this.searchBookName) params.bookName = this.searchBookName;\n      if (this.searchStudent) params.studentInfo = this.searchStudent;\n      if (this.searchStatus) params.status = this.searchStatus;\n\n      // 添加日期范围参数\n      if (this.searchDateRange && this.searchDateRange.length === 2) {\n        params.startDate = this.searchDateRange[0];\n        params.endDate = this.searchDateRange[1];\n      }\n      try {\n        const res = await this.$request.get('/book/borrow/selectPage', {\n          params\n        });\n        console.log('借阅记录列表响应:', res);\n        if (res.code === '200') {\n          this.tableData = res.data?.list || [];\n          this.total = res.data?.total || 0;\n\n          // 为每条记录添加加载状态\n          this.tableData.forEach(record => {\n            record.returnLoading = false;\n          });\n        } else {\n          this.$message.error(res.msg || '获取借阅记录失败');\n        }\n      } catch (error) {\n        console.error('加载借阅记录出错:', error);\n        this.$message.error('请求失败，请检查网络连接');\n      } finally {\n        this.loading = false;\n      }\n    },\n    // 重置搜索条件\n    resetSearch() {\n      this.searchBookName = '';\n      this.searchStudent = '';\n      this.searchStatus = '';\n      this.searchDateRange = [];\n      this.load(1);\n    },\n    // 表格多选\n    handleSelectionChange(rows) {\n      // 只选择未归还的记录\n      this.selectedIds = rows.filter(row => !row.returnTime).map(row => row.id);\n    },\n    // 分页切换\n    handleCurrentChange(pageNum) {\n      this.load(pageNum);\n    },\n    // 每页条数切换\n    handleSizeChange(pageSize) {\n      this.pageSize = pageSize;\n      this.load(1);\n    },\n    // 办理归还（单条）\n    async handleReturn(record) {\n      if (!record.id) {\n        this.$message.warning('无效的记录ID');\n        return;\n      }\n      try {\n        // 设置加载状态\n        record.returnLoading = true;\n        await this.$confirm(`确认归还图书《${record.bookName}》吗？`, '办理归还', {\n          confirmButtonText: '确认归还',\n          cancelButtonText: '取消',\n          type: 'warning'\n        });\n\n        // 获取当前管理员ID\n        const adminId = this.currentAdmin.id;\n        if (!adminId) {\n          this.$message.error('无法获取管理员信息，请重新登录');\n          record.returnLoading = false;\n          return;\n        }\n        console.log('归还参数:', {\n          borrowId: record.id,\n          adminId: adminId\n        });\n\n        // 调用归还接口\n        const res = await this.$request.post(`/book/return/${record.id}`, null, {\n          params: {\n            adminId\n          }\n        });\n        console.log('归还响应:', res);\n        if (res.code === '200') {\n          this.$message.success('归还成功');\n          // 刷新列表\n          this.load(1);\n          // 关闭详情对话框\n          if (this.detailDialogVisible) {\n            this.detailDialogVisible = false;\n          }\n        } else {\n          this.$message.error(res.msg || '归还失败');\n          record.returnLoading = false;\n        }\n      } catch (error) {\n        console.log('取消操作或操作失败:', error);\n        record.returnLoading = false;\n\n        // 如果是用户取消操作，不做处理\n        if (error !== 'cancel' && error.message !== 'cancel') {\n          this.$message.error('操作失败: ' + (error.message || '未知错误'));\n        }\n      }\n    },\n    // 批量归还\n    async handleBatchReturn() {\n      if (this.selectedIds.length === 0) {\n        this.$message.warning('请选择要归还的记录');\n        return;\n      }\n      try {\n        await this.$confirm(`确认批量归还 ${this.selectedIds.length} 条借阅记录吗？`, '批量归还', {\n          confirmButtonText: '确认归还',\n          cancelButtonText: '取消',\n          type: 'warning'\n        });\n        const adminId = this.currentAdmin.id;\n        if (!adminId) {\n          this.$message.error('无法获取管理员信息，请重新登录');\n          return;\n        }\n        let successCount = 0;\n        let failCount = 0;\n\n        // 为选中的记录设置加载状态\n        const selectedRecords = this.tableData.filter(record => this.selectedIds.includes(record.id));\n        selectedRecords.forEach(record => {\n          record.returnLoading = true;\n        });\n\n        // 逐个处理归还\n        for (const borrowId of this.selectedIds) {\n          try {\n            const res = await this.$request.post(`/book/return/${borrowId}`, null, {\n              params: {\n                adminId\n              }\n            });\n            if (res.code === '200') {\n              successCount++;\n            } else {\n              failCount++;\n              console.error(`归还记录 ${borrowId} 失败:`, res.msg);\n            }\n          } catch (error) {\n            failCount++;\n            console.error(`归还记录 ${borrowId} 异常:`, error);\n          }\n        }\n\n        // 清除加载状态\n        selectedRecords.forEach(record => {\n          record.returnLoading = false;\n        });\n\n        // 显示处理结果\n        let message = '';\n        if (successCount > 0) {\n          message += `成功归还 ${successCount} 条记录`;\n        }\n        if (failCount > 0) {\n          message += `，失败 ${failCount} 条记录`;\n        }\n        if (message) {\n          this.$message.success(message);\n        }\n\n        // 刷新数据\n        this.load(1);\n        this.selectedIds = [];\n      } catch (error) {\n        console.log('取消批量归还操作');\n      }\n    },\n    // 查看详情\n    viewDetails(record) {\n      this.currentRecord = JSON.parse(JSON.stringify(record));\n      this.detailDialogVisible = true;\n    },\n    // 导出数据\n    exportData() {\n      this.$message.info('导出功能开发中...');\n    },\n    // 工具方法：格式化日期\n    formatDate(dateStr) {\n      if (!dateStr) return '--';\n      try {\n        const date = new Date(dateStr);\n        return date.toLocaleString('zh-CN', {\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit'\n        }).replace(/\\//g, '-');\n      } catch (e) {\n        return dateStr;\n      }\n    },\n    // 工具方法：获取状态标签类型\n    getStatusTagType(record) {\n      if (record.returnTime) {\n        return 'success'; // 已归还\n      } else if (this.isOverdue(record)) {\n        return 'danger'; // 已超期\n      } else {\n        return 'warning'; // 借阅中\n      }\n    },\n\n    // 工具方法：获取状态文本\n    getStatusText(record) {\n      if (record.returnTime) {\n        return '已归还';\n      } else if (this.isOverdue(record)) {\n        return '已超期';\n      } else {\n        return '借阅中';\n      }\n    },\n    // 判断是否超期\n    isOverdue(record) {\n      if (!record.dueTime || record.returnTime) return false;\n      const dueDate = new Date(record.dueTime);\n      const now = new Date();\n      return now > dueDate;\n    },\n    // 计算超期天数\n    calculateOverdueDays(record) {\n      if (!this.isOverdue(record)) return 0;\n      const dueDate = new Date(record.dueTime);\n      const now = new Date();\n      const diffTime = Math.abs(now - dueDate);\n      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n    }\n  }\n};","map":{"version":3,"names":["name","data","tableData","loading","pageNum","pageSize","total","searchBookName","searchStudent","searchStatus","searchDateRange","selectedIds","detailDialogVisible","currentRecord","currentAdmin","JSON","parse","localStorage","getItem","created","load","methods","params","bookName","studentInfo","status","length","startDate","endDate","res","$request","get","console","log","code","list","forEach","record","returnLoading","$message","error","msg","resetSearch","handleSelectionChange","rows","filter","row","returnTime","map","id","handleCurrentChange","handleSizeChange","handleReturn","warning","$confirm","confirmButtonText","cancelButtonText","type","adminId","borrowId","post","success","message","handleBatchReturn","successCount","failCount","selectedRecords","includes","viewDetails","stringify","exportData","info","formatDate","dateStr","date","Date","toLocaleString","year","month","day","hour","minute","replace","e","getStatusTagType","isOverdue","getStatusText","dueTime","dueDate","now","calculateOverdueDays","diffTime","Math","abs","ceil"],"sources":["src/views/manager/BorrowRecord.vue"],"sourcesContent":["<template>\r\n  <div>\r\n    <!-- 1. 搜索区 -->\r\n    <div class=\"search\">\r\n      <el-input placeholder=\"请输入图书名称\" style=\"width: 200px\" v-model=\"searchBookName\"></el-input>\r\n      <el-input placeholder=\"请输入学生姓名/ID\" style=\"width: 200px; margin-left: 10px\" v-model=\"searchStudent\"></el-input>\r\n      <el-select v-model=\"searchStatus\" placeholder=\"借阅状态\" clearable style=\"width: 120px; margin-left: 10px\">\r\n        <el-option label=\"全部\" value=\"\"></el-option>\r\n        <el-option label=\"借阅中\" value=\"BORROWED\"></el-option>\r\n        <el-option label=\"已归还\" value=\"RETURNED\"></el-option>\r\n        <el-option label=\"已超期\" value=\"OVERDUE\"></el-option>\r\n      </el-select>\r\n\r\n      <!-- 日期范围选择 -->\r\n      <el-date-picker\r\n          v-model=\"searchDateRange\"\r\n          type=\"daterange\"\r\n          range-separator=\"至\"\r\n          start-placeholder=\"开始日期\"\r\n          end-placeholder=\"结束日期\"\r\n          value-format=\"yyyy-MM-dd\"\r\n          style=\"width: 300px; margin-left: 10px\">\r\n      </el-date-picker>\r\n\r\n      <el-button type=\"info\" plain style=\"margin-left: 10px\" @click=\"load(1)\">查询</el-button>\r\n      <el-button type=\"warning\" plain style=\"margin-left: 10px\" @click=\"resetSearch\">重置</el-button>\r\n    </div>\r\n\r\n    <!-- 2. 操作按钮区 -->\r\n    <div class=\"operation\" style=\"margin-top: 15px; margin-bottom: 10px\">\r\n      <el-button type=\"primary\" plain @click=\"load(1)\" icon=\"el-icon-refresh\">刷新</el-button>\r\n      <el-button type=\"success\" plain @click=\"handleBatchReturn\" :disabled=\"selectedIds.length === 0\">\r\n        批量归还({{ selectedIds.length }})\r\n      </el-button>\r\n      <el-button type=\"warning\" plain @click=\"exportData\">导出数据</el-button>\r\n    </div>\r\n\r\n    <!-- 3. 借阅记录表格 -->\r\n    <div class=\"table\">\r\n      <el-table\r\n          :data=\"tableData\"\r\n          stripe\r\n          @selection-change=\"handleSelectionChange\"\r\n          v-loading=\"loading\">\r\n\r\n        <el-table-column type=\"selection\" width=\"55\" align=\"center\"></el-table-column>\r\n\r\n        <el-table-column prop=\"id\" label=\"记录ID\" width=\"90\" align=\"center\" sortable></el-table-column>\r\n\r\n        <!-- 图书信息列 -->\r\n        <el-table-column label=\"图书信息\" min-width=\"180\">\r\n          <template v-slot=\"scope\">\r\n            <div style=\"display: flex; align-items: center;\">\r\n              <div>\r\n                <div style=\"font-weight: 500;\">{{ scope.row.bookName }}</div>\r\n                <div style=\"font-size: 12px; color: #909399;\">\r\n                  {{ scope.row.bookAuthor }} | ISBN: {{ scope.row.bookIsbn }}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 学生信息列 -->\r\n        <el-table-column label=\"借阅学生\" width=\"150\">\r\n          <template v-slot=\"scope\">\r\n            <div>\r\n              <div>{{ scope.row.userName }}</div>\r\n              <div style=\"font-size: 12px; color: #909399;\">ID: {{ scope.row.userId }}</div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 时间信息列 -->\r\n        <el-table-column label=\"借阅时间\" width=\"160\" align=\"center\">\r\n          <template v-slot=\"scope\">\r\n            <div>\r\n              <div>{{ formatDate(scope.row.borrowTime) }}</div>\r\n              <div style=\"font-size: 12px; color: #909399;\">\r\n                应还: {{ formatDate(scope.row.dueTime) }}\r\n              </div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 归还时间列 -->\r\n        <el-table-column label=\"归还时间\" width=\"160\" align=\"center\">\r\n          <template v-slot=\"scope\">\r\n            <div v-if=\"scope.row.returnTime\">\r\n              {{ formatDate(scope.row.returnTime) }}\r\n            </div>\r\n            <div v-else style=\"color: #F56C6C;\">--</div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 状态列 -->\r\n        <el-table-column label=\"状态\" width=\"100\" align=\"center\">\r\n          <template v-slot=\"scope\">\r\n            <el-tag\r\n                :type=\"getStatusTagType(scope.row)\"\r\n                size=\"small\"\r\n                effect=\"dark\">\r\n              {{ getStatusText(scope.row) }}\r\n            </el-tag>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 管理员列 -->\r\n        <el-table-column label=\"操作员\" width=\"120\">\r\n          <template v-slot=\"scope\">\r\n            <div>\r\n              <div>{{ scope.row.adminName || '--' }}</div>\r\n              <div style=\"font-size: 12px; color: #909399;\">ID: {{ scope.row.adminId }}</div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 操作列 -->\r\n        <el-table-column label=\"操作\" width=\"150\" align=\"center\" fixed=\"right\">\r\n          <template v-slot=\"scope\">\r\n            <el-button\r\n                v-if=\"!scope.row.returnTime\"\r\n                type=\"success\"\r\n                size=\"mini\"\r\n                plain\r\n                @click=\"handleReturn(scope.row)\"\r\n                :loading=\"scope.row.returnLoading\">\r\n              办理归还\r\n            </el-button>\r\n            <span v-else style=\"color: #909399;\">已归还</span>\r\n          </template>\r\n        </el-table-column>\r\n      </el-table>\r\n\r\n      <!-- 分页 -->\r\n      <div class=\"pagination\" style=\"margin-top: 15px\">\r\n        <el-pagination\r\n            background\r\n            @current-change=\"handleCurrentChange\"\r\n            @size-change=\"handleSizeChange\"\r\n            :current-page=\"pageNum\"\r\n            :page-sizes=\"[10, 20, 50, 100]\"\r\n            :page-size=\"pageSize\"\r\n            layout=\"total, sizes, prev, pager, next, jumper\"\r\n            :total=\"total\">\r\n        </el-pagination>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 4. 借阅详情对话框 -->\r\n    <el-dialog\r\n        title=\"借阅记录详情\"\r\n        :visible.sync=\"detailDialogVisible\"\r\n        width=\"50%\"\r\n        :close-on-click-modal=\"false\">\r\n\r\n      <div v-if=\"currentRecord\" style=\"line-height: 1.8;\">\r\n        <el-descriptions :column=\"2\" border>\r\n          <el-descriptions-item label=\"借阅编号\">{{ currentRecord.id }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"借阅状态\">\r\n            <el-tag :type=\"getStatusTagType(currentRecord)\" size=\"small\">\r\n              {{ getStatusText(currentRecord) }}\r\n            </el-tag>\r\n          </el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"图书名称\">{{ currentRecord.bookName }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"图书作者\">{{ currentRecord.bookAuthor }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"ISBN\">{{ currentRecord.bookIsbn }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"借阅学生\">{{ currentRecord.userName }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"学生ID\">{{ currentRecord.userId }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"借阅时间\">{{ formatDate(currentRecord.borrowTime) }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"应还时间\">{{ formatDate(currentRecord.dueTime) }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"实际归还时间\" v-if=\"currentRecord.returnTime\">\r\n            {{ formatDate(currentRecord.returnTime) }}\r\n          </el-descriptions-item>\r\n          <el-descriptions-item label=\"实际归还时间\" v-else>--</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"超期天数\" v-if=\"isOverdue(currentRecord)\">\r\n            <span style=\"color: #F56C6C; font-weight: bold;\">{{ calculateOverdueDays(currentRecord) }} 天</span>\r\n          </el-descriptions-item>\r\n          <el-descriptions-item label=\"超期天数\" v-else>0 天</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"操作管理员\">{{ currentRecord.adminName || '--' }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"管理员ID\">{{ currentRecord.adminId }}</el-descriptions-item>\r\n        </el-descriptions>\r\n      </div>\r\n\r\n      <div slot=\"footer\" class=\"dialog-footer\">\r\n        <el-button @click=\"detailDialogVisible = false\">关闭</el-button>\r\n        <el-button\r\n            v-if=\"currentRecord && !currentRecord.returnTime\"\r\n            type=\"primary\"\r\n            @click=\"handleReturn(currentRecord)\">\r\n          办理归还\r\n        </el-button>\r\n      </div>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: \"BorrowRecord\",\r\n  data() {\r\n    return {\r\n      // 表格数据\r\n      tableData: [],\r\n      loading: false,\r\n      pageNum: 1,\r\n      pageSize: 10,\r\n      total: 0,\r\n\r\n      // 搜索条件\r\n      searchBookName: '',\r\n      searchStudent: '',\r\n      searchStatus: '',\r\n      searchDateRange: [],\r\n\r\n      // 选中项\r\n      selectedIds: [],\r\n\r\n      // 对话框\r\n      detailDialogVisible: false,\r\n      currentRecord: null,\r\n\r\n      // 当前登录管理员信息\r\n      currentAdmin: JSON.parse(localStorage.getItem('xm-user') || '{}')\r\n    }\r\n  },\r\n  created() {\r\n    // 页面加载时，获取借阅记录列表\r\n    this.load(1)\r\n  },\r\n  methods: {\r\n    // 加载借阅记录列表\r\n    async load(pageNum) {\r\n      if (pageNum) this.pageNum = pageNum\r\n      this.loading = true\r\n\r\n      // 构建查询参数\r\n      const params = {\r\n        pageNum: this.pageNum,\r\n        pageSize: this.pageSize\r\n      }\r\n\r\n      // 添加可选查询条件\r\n      if (this.searchBookName) params.bookName = this.searchBookName\r\n      if (this.searchStudent) params.studentInfo = this.searchStudent\r\n      if (this.searchStatus) params.status = this.searchStatus\r\n\r\n      // 添加日期范围参数\r\n      if (this.searchDateRange && this.searchDateRange.length === 2) {\r\n        params.startDate = this.searchDateRange[0]\r\n        params.endDate = this.searchDateRange[1]\r\n      }\r\n\r\n      try {\r\n        const res = await this.$request.get('/book/borrow/selectPage', { params })\r\n        console.log('借阅记录列表响应:', res)\r\n\r\n        if (res.code === '200') {\r\n          this.tableData = res.data?.list || []\r\n          this.total = res.data?.total || 0\r\n\r\n          // 为每条记录添加加载状态\r\n          this.tableData.forEach(record => {\r\n            record.returnLoading = false\r\n          })\r\n        } else {\r\n          this.$message.error(res.msg || '获取借阅记录失败')\r\n        }\r\n      } catch (error) {\r\n        console.error('加载借阅记录出错:', error)\r\n        this.$message.error('请求失败，请检查网络连接')\r\n      } finally {\r\n        this.loading = false\r\n      }\r\n    },\r\n\r\n    // 重置搜索条件\r\n    resetSearch() {\r\n      this.searchBookName = ''\r\n      this.searchStudent = ''\r\n      this.searchStatus = ''\r\n      this.searchDateRange = []\r\n      this.load(1)\r\n    },\r\n\r\n    // 表格多选\r\n    handleSelectionChange(rows) {\r\n      // 只选择未归还的记录\r\n      this.selectedIds = rows\r\n          .filter(row => !row.returnTime)\r\n          .map(row => row.id)\r\n    },\r\n\r\n    // 分页切换\r\n    handleCurrentChange(pageNum) {\r\n      this.load(pageNum)\r\n    },\r\n\r\n    // 每页条数切换\r\n    handleSizeChange(pageSize) {\r\n      this.pageSize = pageSize\r\n      this.load(1)\r\n    },\r\n\r\n    // 办理归还（单条）\r\n    async handleReturn(record) {\r\n      if (!record.id) {\r\n        this.$message.warning('无效的记录ID')\r\n        return\r\n      }\r\n\r\n      try {\r\n        // 设置加载状态\r\n        record.returnLoading = true\r\n\r\n        await this.$confirm(`确认归还图书《${record.bookName}》吗？`, '办理归还', {\r\n          confirmButtonText: '确认归还',\r\n          cancelButtonText: '取消',\r\n          type: 'warning'\r\n        })\r\n\r\n        // 获取当前管理员ID\r\n        const adminId = this.currentAdmin.id\r\n        if (!adminId) {\r\n          this.$message.error('无法获取管理员信息，请重新登录')\r\n          record.returnLoading = false\r\n          return\r\n        }\r\n\r\n        console.log('归还参数:', {\r\n          borrowId: record.id,\r\n          adminId: adminId\r\n        })\r\n\r\n        // 调用归还接口\r\n        const res = await this.$request.post(`/book/return/${record.id}`, null, {\r\n          params: { adminId }\r\n        })\r\n\r\n        console.log('归还响应:', res)\r\n\r\n        if (res.code === '200') {\r\n          this.$message.success('归还成功')\r\n          // 刷新列表\r\n          this.load(1)\r\n          // 关闭详情对话框\r\n          if (this.detailDialogVisible) {\r\n            this.detailDialogVisible = false\r\n          }\r\n        } else {\r\n          this.$message.error(res.msg || '归还失败')\r\n          record.returnLoading = false\r\n        }\r\n      } catch (error) {\r\n        console.log('取消操作或操作失败:', error)\r\n        record.returnLoading = false\r\n\r\n        // 如果是用户取消操作，不做处理\r\n        if (error !== 'cancel' && error.message !== 'cancel') {\r\n          this.$message.error('操作失败: ' + (error.message || '未知错误'))\r\n        }\r\n      }\r\n    },\r\n\r\n    // 批量归还\r\n    async handleBatchReturn() {\r\n      if (this.selectedIds.length === 0) {\r\n        this.$message.warning('请选择要归还的记录')\r\n        return\r\n      }\r\n\r\n      try {\r\n        await this.$confirm(`确认批量归还 ${this.selectedIds.length} 条借阅记录吗？`, '批量归还', {\r\n          confirmButtonText: '确认归还',\r\n          cancelButtonText: '取消',\r\n          type: 'warning'\r\n        })\r\n\r\n        const adminId = this.currentAdmin.id\r\n        if (!adminId) {\r\n          this.$message.error('无法获取管理员信息，请重新登录')\r\n          return\r\n        }\r\n\r\n        let successCount = 0\r\n        let failCount = 0\r\n\r\n        // 为选中的记录设置加载状态\r\n        const selectedRecords = this.tableData.filter(record => this.selectedIds.includes(record.id))\r\n        selectedRecords.forEach(record => {\r\n          record.returnLoading = true\r\n        })\r\n\r\n        // 逐个处理归还\r\n        for (const borrowId of this.selectedIds) {\r\n          try {\r\n            const res = await this.$request.post(`/book/return/${borrowId}`, null, {\r\n              params: { adminId }\r\n            })\r\n\r\n            if (res.code === '200') {\r\n              successCount++\r\n            } else {\r\n              failCount++\r\n              console.error(`归还记录 ${borrowId} 失败:`, res.msg)\r\n            }\r\n          } catch (error) {\r\n            failCount++\r\n            console.error(`归还记录 ${borrowId} 异常:`, error)\r\n          }\r\n        }\r\n\r\n        // 清除加载状态\r\n        selectedRecords.forEach(record => {\r\n          record.returnLoading = false\r\n        })\r\n\r\n        // 显示处理结果\r\n        let message = ''\r\n        if (successCount > 0) {\r\n          message += `成功归还 ${successCount} 条记录`\r\n        }\r\n        if (failCount > 0) {\r\n          message += `，失败 ${failCount} 条记录`\r\n        }\r\n\r\n        if (message) {\r\n          this.$message.success(message)\r\n        }\r\n\r\n        // 刷新数据\r\n        this.load(1)\r\n        this.selectedIds = []\r\n\r\n      } catch (error) {\r\n        console.log('取消批量归还操作')\r\n      }\r\n    },\r\n\r\n    // 查看详情\r\n    viewDetails(record) {\r\n      this.currentRecord = JSON.parse(JSON.stringify(record))\r\n      this.detailDialogVisible = true\r\n    },\r\n\r\n    // 导出数据\r\n    exportData() {\r\n      this.$message.info('导出功能开发中...')\r\n    },\r\n\r\n    // 工具方法：格式化日期\r\n    formatDate(dateStr) {\r\n      if (!dateStr) return '--'\r\n      try {\r\n        const date = new Date(dateStr)\r\n        return date.toLocaleString('zh-CN', {\r\n          year: 'numeric',\r\n          month: '2-digit',\r\n          day: '2-digit',\r\n          hour: '2-digit',\r\n          minute: '2-digit'\r\n        }).replace(/\\//g, '-')\r\n      } catch (e) {\r\n        return dateStr\r\n      }\r\n    },\r\n\r\n    // 工具方法：获取状态标签类型\r\n    getStatusTagType(record) {\r\n      if (record.returnTime) {\r\n        return 'success'  // 已归还\r\n      } else if (this.isOverdue(record)) {\r\n        return 'danger'   // 已超期\r\n      } else {\r\n        return 'warning'  // 借阅中\r\n      }\r\n    },\r\n\r\n    // 工具方法：获取状态文本\r\n    getStatusText(record) {\r\n      if (record.returnTime) {\r\n        return '已归还'\r\n      } else if (this.isOverdue(record)) {\r\n        return '已超期'\r\n      } else {\r\n        return '借阅中'\r\n      }\r\n    },\r\n\r\n    // 判断是否超期\r\n    isOverdue(record) {\r\n      if (!record.dueTime || record.returnTime) return false\r\n\r\n      const dueDate = new Date(record.dueTime)\r\n      const now = new Date()\r\n      return now > dueDate\r\n    },\r\n\r\n    // 计算超期天数\r\n    calculateOverdueDays(record) {\r\n      if (!this.isOverdue(record)) return 0\r\n\r\n      const dueDate = new Date(record.dueTime)\r\n      const now = new Date()\r\n      const diffTime = Math.abs(now - dueDate)\r\n      return Math.ceil(diffTime / (1000 * 60 * 60 * 24))\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.search, .operation {\r\n  margin-bottom: 15px;\r\n}\r\n\r\n/* 表格行悬停效果 */\r\n.el-table >>> .hover-row {\r\n  cursor: pointer;\r\n  transition: background-color 0.3s;\r\n}\r\n\r\n.el-table >>> .hover-row:hover {\r\n  background-color: #f5f7fa !important;\r\n}\r\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}