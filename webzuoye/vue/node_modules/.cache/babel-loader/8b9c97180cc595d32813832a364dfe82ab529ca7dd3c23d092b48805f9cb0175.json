{"ast":null,"code":"import bookApi from '@/api/book';\nexport default {\n  name: 'CategoryManager',\n  props: {\n    visible: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data() {\n    return {\n      // 主表格数据\n      tableData: [],\n      loading: false,\n      pageNum: 1,\n      pageSize: 10,\n      total: 0,\n      searchName: '',\n      // 内层表单对话框\n      innerDialogVisible: false,\n      formTitle: '',\n      form: {\n        id: null,\n        name: '',\n        description: ''\n      },\n      rules: {\n        name: [{\n          required: true,\n          message: '请输入分类名称',\n          trigger: 'blur'\n        }, {\n          max: 20,\n          message: '长度不超过20个字符',\n          trigger: 'blur'\n        }]\n      }\n    };\n  },\n  computed: {\n    dialogVisible: {\n      get() {\n        return this.visible;\n      },\n      set(val) {\n        this.$emit('update:visible', val);\n      }\n    }\n  },\n  watch: {\n    visible(newVal) {\n      if (newVal) {\n        this.load(1); // 每次打开弹窗都重新加载数据\n      } else {\n        this.resetSearch(); // 关闭时重置内部状态\n      }\n    }\n  },\n\n  methods: {\n    // 加载分类列表\n    async load() {\n      this.loading = true;\n      try {\n        const res = await this.$request.get('/category/selectAll');\n        if (res.code === '200') {\n          let allData = res.data || [];\n\n          // 前端搜索筛选\n          if (this.searchName) {\n            allData = allData.filter(item => item.name && item.name.toLowerCase().includes(this.searchName.toLowerCase()));\n          }\n          this.total = allData.length;\n\n          // 前端分页\n          const start = (this.pageNum - 1) * this.pageSize;\n          const end = start + this.pageSize;\n          this.tableData = allData.slice(start, end);\n        } else {\n          this.$message.error(res.msg || '获取分类失败');\n        }\n      } catch (error) {\n        console.error('获取分类失败:', error);\n        this.$message.error('获取分类失败');\n      } finally {\n        this.loading = false;\n      }\n    },\n    // 重置搜索\n    resetSearch() {\n      this.searchName = '';\n      this.pageNum = 1;\n      // 注意：这里不自动调用load，由watch触发\n    },\n\n    // 处理新增\n    handleAdd() {\n      this.form = {\n        id: null,\n        name: '',\n        description: ''\n      };\n      this.formTitle = '新增分类';\n      this.innerDialogVisible = true;\n      this.$nextTick(() => {\n        if (this.$refs.formRef) {\n          this.$refs.formRef.clearValidate();\n        }\n      });\n    },\n    // 处理编辑\n    handleEdit(row) {\n      this.form = JSON.parse(JSON.stringify(row));\n      this.formTitle = '编辑分类';\n      this.innerDialogVisible = true;\n      this.$nextTick(() => {\n        if (this.$refs.formRef) {\n          this.$refs.formRef.clearValidate();\n        }\n      });\n    },\n    // 保存分类（新增或修改）\n    async saveCategory() {\n      try {\n        const valid = await this.$refs.formRef.validate();\n        if (!valid) return;\n        const url = this.form.id ? '/category/update' : '/category/add';\n        const method = this.form.id ? 'put' : 'post';\n        const res = await this.$request({\n          url: url,\n          method: method,\n          data: this.form\n        });\n        if (res.code === '200') {\n          this.$message.success(this.form.id ? '修改成功' : '添加成功');\n          this.innerDialogVisible = false;\n          this.load(); // 刷新列表\n          this.$emit('refresh'); // 通知父组件刷新下拉框\n        } else {\n          this.$message.error(res.msg || '操作失败');\n        }\n      } catch (error) {\n        console.error('保存分类出错:', error);\n      }\n    },\n    // 删除分类\n    handleDelete(id) {\n      // 删除前的检查：这里可以添加检查该分类下是否有图书的逻辑\n      // 假设我们直接删除，实际应用中可能需要先检查\n      this.$confirm('确定要删除这个分类吗？如果该分类下有图书，删除可能会失败。', '确认删除', {\n        type: 'warning',\n        confirmButtonText: '确定删除',\n        cancelButtonText: '再想想'\n      }).then(() => {\n        bookApi.deleteCategory(id).then(res => {\n          if (res.code === '200') {\n            this.$message.success('删除成功');\n            this.load(1); // 刷新列表\n            this.$emit('refresh'); // 通知父组件刷新下拉框\n          } else {\n            this.$message.error(res.msg || '删除失败，可能该分类下仍有图书');\n          }\n        });\n      }).catch(() => {});\n    },\n    // 分页切换\n    handleCurrentChange(pageNum) {\n      this.pageNum = pageNum;\n      this.load();\n    }\n  }\n};","map":{"version":3,"names":["bookApi","name","props","visible","type","Boolean","default","data","tableData","loading","pageNum","pageSize","total","searchName","innerDialogVisible","formTitle","form","id","description","rules","required","message","trigger","max","computed","dialogVisible","get","set","val","$emit","watch","newVal","load","resetSearch","methods","res","$request","code","allData","filter","item","toLowerCase","includes","length","start","end","slice","$message","error","msg","console","handleAdd","$nextTick","$refs","formRef","clearValidate","handleEdit","row","JSON","parse","stringify","saveCategory","valid","validate","url","method","success","handleDelete","$confirm","confirmButtonText","cancelButtonText","then","deleteCategory","catch","handleCurrentChange"],"sources":["src/views/manager/CategoryManager.vue"],"sourcesContent":["<template>\r\n  <el-dialog title=\"分类管理\" :visible.sync=\"dialogVisible\" width=\"60%\" :close-on-click-modal=\"false\" destroy-on-close>\r\n    <!-- 搜索和操作区 -->\r\n    <div style=\"margin-bottom: 20px;\">\r\n      <el-input v-model=\"searchName\" placeholder=\"请输入分类名称\" style=\"width: 200px;\" clearable @clear=\"load(1)\" @keyup.enter.native=\"load(1)\"></el-input>\r\n      <el-button type=\"info\" plain style=\"margin-left: 10px\" @click=\"load(1)\">搜索</el-button>\r\n      <el-button type=\"warning\" plain style=\"margin-left: 10px\" @click=\"resetSearch\">重置</el-button>\r\n      <el-button type=\"primary\" plain style=\"margin-left: 20px\" @click=\"handleAdd\">新增分类</el-button>\r\n    </div>\r\n\r\n    <!-- 分类数据表格 -->\r\n    <el-table-column label=\"操作\" width=\"150\" align=\"center\" fixed=\"right\">\r\n      <template v-slot=\"scope\">\r\n        <el-button type=\"primary\" size=\"mini\" @click=\"handleEdit(scope.row)\">编辑</el-button>\r\n        <el-button\r\n            type=\"danger\"\r\n            size=\"mini\"\r\n            @click=\"handleDelete(scope.row)\"\r\n            :loading=\"scope.row.deleting\">删除</el-button>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <!-- 分页 -->\r\n    <div style=\"margin-top: 15px; text-align: center;\">\r\n      <el-pagination\r\n          background\r\n          @current-change=\"handleCurrentChange\"\r\n          :current-page=\"pageNum\"\r\n          :page-size=\"pageSize\"\r\n          layout=\"total, prev, pager, next\"\r\n          :total=\"total\">\r\n      </el-pagination>\r\n    </div>\r\n\r\n    <!-- 新增/编辑分类的对话框 -->\r\n    <el-dialog :title=\"formTitle\" :visible.sync=\"innerDialogVisible\" width=\"30%\" append-to-body :close-on-click-modal=\"false\">\r\n      <el-form :model=\"form\" :rules=\"rules\" ref=\"formRef\" label-width=\"80px\">\r\n        <el-form-item label=\"分类名称\" prop=\"name\">\r\n          <el-input v-model=\"form.name\" placeholder=\"例如：计算机科学、文学小说\"></el-input>\r\n        </el-form-item>\r\n        <el-form-item label=\"描述\" prop=\"description\">\r\n          <el-input type=\"textarea\" v-model=\"form.description\" placeholder=\"请输入分类描述（可选）\" :rows=\"3\"></el-input>\r\n        </el-form-item>\r\n      </el-form>\r\n      <div slot=\"footer\" class=\"dialog-footer\">\r\n        <el-button @click=\"innerDialogVisible = false\">取消</el-button>\r\n        <el-button type=\"primary\" @click=\"saveCategory\">确定</el-button>\r\n      </div>\r\n    </el-dialog>\r\n  </el-dialog>\r\n</template>\r\n\r\n<script>\r\nimport bookApi from '@/api/book'\r\n\r\nexport default {\r\n  name: 'CategoryManager',\r\n  props: {\r\n    visible: {\r\n      type: Boolean,\r\n      default: false\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      // 主表格数据\r\n      tableData: [],\r\n      loading: false,\r\n      pageNum: 1,\r\n      pageSize: 10,\r\n      total: 0,\r\n      searchName: '',\r\n\r\n      // 内层表单对话框\r\n      innerDialogVisible: false,\r\n      formTitle: '',\r\n      form: {\r\n        id: null,\r\n        name: '',\r\n        description: ''\r\n      },\r\n      rules: {\r\n        name: [\r\n          { required: true, message: '请输入分类名称', trigger: 'blur' },\r\n          { max: 20, message: '长度不超过20个字符', trigger: 'blur' }\r\n        ]\r\n      }\r\n      \r\n    }\r\n  },\r\n  computed: {\r\n    dialogVisible: {\r\n      get() {\r\n        return this.visible\r\n      },\r\n      set(val) {\r\n        this.$emit('update:visible', val)\r\n      }\r\n    }\r\n  },\r\n  watch: {\r\n    visible(newVal) {\r\n      if (newVal) {\r\n        this.load(1) // 每次打开弹窗都重新加载数据\r\n      } else {\r\n        this.resetSearch() // 关闭时重置内部状态\r\n      }\r\n    }\r\n  },\r\n  methods: {\r\n    // 加载分类列表\r\n    async load() {\r\n      this.loading = true\r\n      try {\r\n        const res = await this.$request.get('/category/selectAll')\r\n        if (res.code === '200') {\r\n          let allData = res.data || []\r\n\r\n          // 前端搜索筛选\r\n          if (this.searchName) {\r\n            allData = allData.filter(item =>\r\n                item.name && item.name.toLowerCase().includes(this.searchName.toLowerCase())\r\n            )\r\n          }\r\n\r\n          this.total = allData.length\r\n\r\n          // 前端分页\r\n          const start = (this.pageNum - 1) * this.pageSize\r\n          const end = start + this.pageSize\r\n          this.tableData = allData.slice(start, end)\r\n        } else {\r\n          this.$message.error(res.msg || '获取分类失败')\r\n        }\r\n      } catch (error) {\r\n        console.error('获取分类失败:', error)\r\n        this.$message.error('获取分类失败')\r\n      } finally {\r\n        this.loading = false\r\n      }\r\n    },\r\n\r\n    // 重置搜索\r\n    resetSearch() {\r\n      this.searchName = ''\r\n      this.pageNum = 1\r\n      // 注意：这里不自动调用load，由watch触发\r\n    },\r\n\r\n    // 处理新增\r\n    handleAdd() {\r\n      this.form = { id: null, name: '', description: '' }\r\n      this.formTitle = '新增分类'\r\n      this.innerDialogVisible = true\r\n      this.$nextTick(() => {\r\n        if (this.$refs.formRef) {\r\n          this.$refs.formRef.clearValidate()\r\n        }\r\n      })\r\n    },\r\n\r\n    // 处理编辑\r\n    handleEdit(row) {\r\n      this.form = JSON.parse(JSON.stringify(row))\r\n      this.formTitle = '编辑分类'\r\n      this.innerDialogVisible = true\r\n      this.$nextTick(() => {\r\n        if (this.$refs.formRef) {\r\n          this.$refs.formRef.clearValidate()\r\n        }\r\n      })\r\n    },\r\n\r\n    // 保存分类（新增或修改）\r\n    async saveCategory() {\r\n      try {\r\n        const valid = await this.$refs.formRef.validate()\r\n        if (!valid) return\r\n\r\n        const url = this.form.id ? '/category/update' : '/category/add'\r\n        const method = this.form.id ? 'put' : 'post'\r\n\r\n        const res = await this.$request({\r\n          url: url,\r\n          method: method,\r\n          data: this.form\r\n        })\r\n\r\n        if (res.code === '200') {\r\n          this.$message.success(this.form.id ? '修改成功' : '添加成功')\r\n          this.innerDialogVisible = false\r\n          this.load() // 刷新列表\r\n          this.$emit('refresh') // 通知父组件刷新下拉框\r\n        } else {\r\n          this.$message.error(res.msg || '操作失败')\r\n        }\r\n      } catch (error) {\r\n        console.error('保存分类出错:', error)\r\n      }\r\n    },\r\n\r\n    // 删除分类\r\n    handleDelete(id) {\r\n      // 删除前的检查：这里可以添加检查该分类下是否有图书的逻辑\r\n      // 假设我们直接删除，实际应用中可能需要先检查\r\n      this.$confirm('确定要删除这个分类吗？如果该分类下有图书，删除可能会失败。', '确认删除', {\r\n        type: 'warning',\r\n        confirmButtonText: '确定删除',\r\n        cancelButtonText: '再想想'\r\n      }).then(() => {\r\n        bookApi.deleteCategory(id).then(res => {\r\n          if (res.code === '200') {\r\n            this.$message.success('删除成功')\r\n            this.load(1) // 刷新列表\r\n            this.$emit('refresh') // 通知父组件刷新下拉框\r\n          } else {\r\n            this.$message.error(res.msg || '删除失败，可能该分类下仍有图书')\r\n          }\r\n        })\r\n      }).catch(() => {})\r\n    },\r\n\r\n    // 分页切换\r\n    handleCurrentChange(pageNum) {\r\n      this.pageNum = pageNum\r\n      this.load()\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n/* 可以添加一些自定义样式 */\r\n.el-table {\r\n  margin-top: 10px;\r\n}\r\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}