{"ast":null,"code":"import bookApi from '@/api/book';\nexport default {\n  name: 'CategoryManager',\n  props: {\n    visible: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data() {\n    return {\n      // 主表格数据\n      tableData: [],\n      loading: false,\n      pageNum: 1,\n      pageSize: 10,\n      total: 0,\n      searchName: '',\n      // 内层表单对话框\n      innerDialogVisible: false,\n      formTitle: '',\n      form: {\n        id: null,\n        name: '',\n        description: ''\n      },\n      rules: {\n        name: [{\n          required: true,\n          message: '请输入分类名称',\n          trigger: 'blur'\n        }, {\n          max: 20,\n          message: '长度不超过20个字符',\n          trigger: 'blur'\n        }]\n      },\n      deletingIds: []\n    };\n  },\n  computed: {\n    dialogVisible: {\n      get() {\n        return this.visible;\n      },\n      set(val) {\n        this.$emit('update:visible', val);\n      }\n    }\n  },\n  watch: {\n    visible(newVal) {\n      if (newVal) {\n        this.load(1); // 每次打开弹窗都重新加载数据\n      } else {\n        this.resetSearch(); // 关闭时重置内部状态\n      }\n    }\n  },\n\n  methods: {\n    // 加载分类列表\n    async load() {\n      this.loading = true;\n      try {\n        const res = await this.$request.get('/category/selectAll');\n        if (res.code === '200') {\n          let allData = res.data || [];\n\n          // 前端搜索筛选\n          if (this.searchName) {\n            allData = allData.filter(item => item.name && item.name.toLowerCase().includes(this.searchName.toLowerCase()));\n          }\n          this.total = allData.length;\n\n          // 前端分页\n          const start = (this.pageNum - 1) * this.pageSize;\n          const end = start + this.pageSize;\n          this.tableData = allData.slice(start, end);\n        } else {\n          this.$message.error(res.msg || '获取分类失败');\n        }\n      } catch (error) {\n        console.error('获取分类失败:', error);\n        this.$message.error('获取分类失败');\n      } finally {\n        this.loading = false;\n      }\n    },\n    // 重置搜索\n    resetSearch() {\n      this.searchName = '';\n      this.pageNum = 1;\n      // 注意：这里不自动调用load，由watch触发\n    },\n\n    // 处理新增\n    handleAdd() {\n      this.form = {\n        id: null,\n        name: '',\n        description: ''\n      };\n      this.formTitle = '新增分类';\n      this.innerDialogVisible = true;\n      this.$nextTick(() => {\n        if (this.$refs.formRef) {\n          this.$refs.formRef.clearValidate();\n        }\n      });\n    },\n    // 处理编辑\n    handleEdit(row) {\n      this.form = JSON.parse(JSON.stringify(row));\n      this.formTitle = '编辑分类';\n      this.innerDialogVisible = true;\n      this.$nextTick(() => {\n        if (this.$refs.formRef) {\n          this.$refs.formRef.clearValidate();\n        }\n      });\n    },\n    // 保存分类（新增或修改）\n    async saveCategory() {\n      try {\n        const valid = await this.$refs.formRef.validate();\n        if (!valid) return;\n        const url = this.form.id ? '/category/update' : '/category/add';\n        const method = this.form.id ? 'put' : 'post';\n        const res = await this.$request({\n          url: url,\n          method: method,\n          data: this.form\n        });\n        if (res.code === '200') {\n          this.$message.success(this.form.id ? '修改成功' : '添加成功');\n          this.innerDialogVisible = false;\n          this.load(); // 刷新列表\n          this.$emit('refresh'); // 通知父组件刷新下拉框\n        } else {\n          this.$message.error(res.msg || '操作失败');\n        }\n      } catch (error) {\n        console.error('保存分类出错:', error);\n      }\n    },\n    // 删除分类\n    async handleDelete(row) {\n      console.log('开始删除分类:', row);\n      try {\n        // 显示确认对话框\n        await this.$confirm(`确定删除分类 \"${row.name}\" 吗？如果该分类下有图书，删除可能会失败。`, '确认删除', {\n          confirmButtonText: '确定删除',\n          cancelButtonText: '取消',\n          type: 'warning'\n        });\n\n        // 标记为删除中\n        row.deleting = true;\n        console.log('调用分类删除接口，ID:', row.id);\n\n        // 调用删除接口\n        const res = await this.$request.delete('/category/delete/' + row.id);\n        console.log('分类删除响应:', res);\n        if (res.code === '200') {\n          this.$message.success('删除成功');\n\n          // 从列表中移除\n          const index = this.tableData.findIndex(item => item.id === row.id);\n          if (index !== -1) {\n            this.tableData.splice(index, 1);\n            this.total--;\n          }\n\n          // 触发刷新事件，让父组件更新下拉框\n          this.$emit('refresh');\n        } else {\n          // 显示具体的错误信息\n          let errorMsg = res.msg || '删除失败';\n          if (errorMsg.includes('关联') || errorMsg.includes('图书') || errorMsg.includes('外键')) {\n            errorMsg = `删除失败：分类\"${row.name}\"下还有图书，请先删除或移动这些图书`;\n          }\n          this.$message.error(errorMsg);\n        }\n      } catch (error) {\n        console.log('分类删除操作取消或异常:', error);\n\n        // 如果是用户取消操作，不显示错误信息\n        if (error !== 'cancel' && error.message !== 'cancel') {\n          this.$message.error('删除失败：' + (error.message || '未知错误'));\n        }\n      } finally {\n        // 清除删除状态\n        row.deleting = false;\n      }\n    },\n    // 分页切换\n    handleCurrentChange(pageNum) {\n      this.pageNum = pageNum;\n      this.load();\n    }\n  }\n};","map":{"version":3,"names":["bookApi","name","props","visible","type","Boolean","default","data","tableData","loading","pageNum","pageSize","total","searchName","innerDialogVisible","formTitle","form","id","description","rules","required","message","trigger","max","deletingIds","computed","dialogVisible","get","set","val","$emit","watch","newVal","load","resetSearch","methods","res","$request","code","allData","filter","item","toLowerCase","includes","length","start","end","slice","$message","error","msg","console","handleAdd","$nextTick","$refs","formRef","clearValidate","handleEdit","row","JSON","parse","stringify","saveCategory","valid","validate","url","method","success","handleDelete","log","$confirm","confirmButtonText","cancelButtonText","deleting","delete","index","findIndex","splice","errorMsg","handleCurrentChange"],"sources":["src/views/manager/CategoryManager.vue"],"sourcesContent":["<template>\r\n  <el-dialog title=\"分类管理\" :visible.sync=\"dialogVisible\" width=\"60%\" :close-on-click-modal=\"false\" destroy-on-close>\r\n    <!-- 搜索和操作区 -->\r\n    <div style=\"margin-bottom: 20px;\">\r\n      <el-input v-model=\"searchName\" placeholder=\"请输入分类名称\" style=\"width: 200px;\" clearable @clear=\"load(1)\" @keyup.enter.native=\"load(1)\"></el-input>\r\n      <el-button type=\"info\" plain style=\"margin-left: 10px\" @click=\"load(1)\">搜索</el-button>\r\n      <el-button type=\"warning\" plain style=\"margin-left: 10px\" @click=\"resetSearch\">重置</el-button>\r\n      <el-button type=\"primary\" plain style=\"margin-left: 20px\" @click=\"handleAdd\">新增分类</el-button>\r\n    </div>\r\n\r\n    <!-- 分类数据表格 -->\r\n    <el-table-column label=\"操作\" width=\"150\" align=\"center\" fixed=\"right\">\r\n      <template v-slot=\"scope\">\r\n        <el-button type=\"primary\" size=\"mini\" @click=\"handleEdit(scope.row)\">编辑</el-button>\r\n        <el-button\r\n            type=\"danger\"\r\n            size=\"mini\"\r\n            @click=\"handleDelete(scope.row)\"\r\n            :loading=\"scope.row.deleting\">删除</el-button>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <!-- 分页 -->\r\n    <div style=\"margin-top: 15px; text-align: center;\">\r\n      <el-pagination\r\n          background\r\n          @current-change=\"handleCurrentChange\"\r\n          :current-page=\"pageNum\"\r\n          :page-size=\"pageSize\"\r\n          layout=\"total, prev, pager, next\"\r\n          :total=\"total\">\r\n      </el-pagination>\r\n    </div>\r\n\r\n    <!-- 新增/编辑分类的对话框 -->\r\n    <el-dialog :title=\"formTitle\" :visible.sync=\"innerDialogVisible\" width=\"30%\" append-to-body :close-on-click-modal=\"false\">\r\n      <el-form :model=\"form\" :rules=\"rules\" ref=\"formRef\" label-width=\"80px\">\r\n        <el-form-item label=\"分类名称\" prop=\"name\">\r\n          <el-input v-model=\"form.name\" placeholder=\"例如：计算机科学、文学小说\"></el-input>\r\n        </el-form-item>\r\n        <el-form-item label=\"描述\" prop=\"description\">\r\n          <el-input type=\"textarea\" v-model=\"form.description\" placeholder=\"请输入分类描述（可选）\" :rows=\"3\"></el-input>\r\n        </el-form-item>\r\n      </el-form>\r\n      <div slot=\"footer\" class=\"dialog-footer\">\r\n        <el-button @click=\"innerDialogVisible = false\">取消</el-button>\r\n        <el-button type=\"primary\" @click=\"saveCategory\">确定</el-button>\r\n      </div>\r\n    </el-dialog>\r\n  </el-dialog>\r\n</template>\r\n\r\n<script>\r\nimport bookApi from '@/api/book'\r\n\r\nexport default {\r\n  name: 'CategoryManager',\r\n  props: {\r\n    visible: {\r\n      type: Boolean,\r\n      default: false\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      // 主表格数据\r\n      tableData: [],\r\n      loading: false,\r\n      pageNum: 1,\r\n      pageSize: 10,\r\n      total: 0,\r\n      searchName: '',\r\n\r\n      // 内层表单对话框\r\n      innerDialogVisible: false,\r\n      formTitle: '',\r\n      form: {\r\n        id: null,\r\n        name: '',\r\n        description: ''\r\n      },\r\n      rules: {\r\n        name: [\r\n          { required: true, message: '请输入分类名称', trigger: 'blur' },\r\n          { max: 20, message: '长度不超过20个字符', trigger: 'blur' }\r\n        ]\r\n      },\r\n      deletingIds: []\r\n    }\r\n  },\r\n  computed: {\r\n    dialogVisible: {\r\n      get() {\r\n        return this.visible\r\n      },\r\n      set(val) {\r\n        this.$emit('update:visible', val)\r\n      }\r\n    }\r\n  },\r\n  watch: {\r\n    visible(newVal) {\r\n      if (newVal) {\r\n        this.load(1) // 每次打开弹窗都重新加载数据\r\n      } else {\r\n        this.resetSearch() // 关闭时重置内部状态\r\n      }\r\n    }\r\n  },\r\n  methods: {\r\n    // 加载分类列表\r\n    async load() {\r\n      this.loading = true\r\n      try {\r\n        const res = await this.$request.get('/category/selectAll')\r\n        if (res.code === '200') {\r\n          let allData = res.data || []\r\n\r\n          // 前端搜索筛选\r\n          if (this.searchName) {\r\n            allData = allData.filter(item =>\r\n                item.name && item.name.toLowerCase().includes(this.searchName.toLowerCase())\r\n            )\r\n          }\r\n\r\n          this.total = allData.length\r\n\r\n          // 前端分页\r\n          const start = (this.pageNum - 1) * this.pageSize\r\n          const end = start + this.pageSize\r\n          this.tableData = allData.slice(start, end)\r\n        } else {\r\n          this.$message.error(res.msg || '获取分类失败')\r\n        }\r\n      } catch (error) {\r\n        console.error('获取分类失败:', error)\r\n        this.$message.error('获取分类失败')\r\n      } finally {\r\n        this.loading = false\r\n      }\r\n    },\r\n\r\n    // 重置搜索\r\n    resetSearch() {\r\n      this.searchName = ''\r\n      this.pageNum = 1\r\n      // 注意：这里不自动调用load，由watch触发\r\n    },\r\n\r\n    // 处理新增\r\n    handleAdd() {\r\n      this.form = { id: null, name: '', description: '' }\r\n      this.formTitle = '新增分类'\r\n      this.innerDialogVisible = true\r\n      this.$nextTick(() => {\r\n        if (this.$refs.formRef) {\r\n          this.$refs.formRef.clearValidate()\r\n        }\r\n      })\r\n    },\r\n\r\n    // 处理编辑\r\n    handleEdit(row) {\r\n      this.form = JSON.parse(JSON.stringify(row))\r\n      this.formTitle = '编辑分类'\r\n      this.innerDialogVisible = true\r\n      this.$nextTick(() => {\r\n        if (this.$refs.formRef) {\r\n          this.$refs.formRef.clearValidate()\r\n        }\r\n      })\r\n    },\r\n\r\n    // 保存分类（新增或修改）\r\n    async saveCategory() {\r\n      try {\r\n        const valid = await this.$refs.formRef.validate()\r\n        if (!valid) return\r\n\r\n        const url = this.form.id ? '/category/update' : '/category/add'\r\n        const method = this.form.id ? 'put' : 'post'\r\n\r\n        const res = await this.$request({\r\n          url: url,\r\n          method: method,\r\n          data: this.form\r\n        })\r\n\r\n        if (res.code === '200') {\r\n          this.$message.success(this.form.id ? '修改成功' : '添加成功')\r\n          this.innerDialogVisible = false\r\n          this.load() // 刷新列表\r\n          this.$emit('refresh') // 通知父组件刷新下拉框\r\n        } else {\r\n          this.$message.error(res.msg || '操作失败')\r\n        }\r\n      } catch (error) {\r\n        console.error('保存分类出错:', error)\r\n      }\r\n    },\r\n\r\n    // 删除分类\r\n    async handleDelete(row) {\r\n      console.log('开始删除分类:', row)\r\n\r\n      try {\r\n        // 显示确认对话框\r\n        await this.$confirm(\r\n            `确定删除分类 \"${row.name}\" 吗？如果该分类下有图书，删除可能会失败。`,\r\n            '确认删除',\r\n            {\r\n              confirmButtonText: '确定删除',\r\n              cancelButtonText: '取消',\r\n              type: 'warning'\r\n            }\r\n        )\r\n\r\n        // 标记为删除中\r\n        row.deleting = true\r\n\r\n        console.log('调用分类删除接口，ID:', row.id)\r\n\r\n        // 调用删除接口\r\n        const res = await this.$request.delete('/category/delete/' + row.id)\r\n        console.log('分类删除响应:', res)\r\n\r\n        if (res.code === '200') {\r\n          this.$message.success('删除成功')\r\n\r\n          // 从列表中移除\r\n          const index = this.tableData.findIndex(item => item.id === row.id)\r\n          if (index !== -1) {\r\n            this.tableData.splice(index, 1)\r\n            this.total--\r\n          }\r\n\r\n          // 触发刷新事件，让父组件更新下拉框\r\n          this.$emit('refresh')\r\n        } else {\r\n          // 显示具体的错误信息\r\n          let errorMsg = res.msg || '删除失败'\r\n\r\n          if (errorMsg.includes('关联') || errorMsg.includes('图书') || errorMsg.includes('外键')) {\r\n            errorMsg = `删除失败：分类\"${row.name}\"下还有图书，请先删除或移动这些图书`\r\n          }\r\n\r\n          this.$message.error(errorMsg)\r\n        }\r\n      } catch (error) {\r\n        console.log('分类删除操作取消或异常:', error)\r\n\r\n        // 如果是用户取消操作，不显示错误信息\r\n        if (error !== 'cancel' && error.message !== 'cancel') {\r\n          this.$message.error('删除失败：' + (error.message || '未知错误'))\r\n        }\r\n      } finally {\r\n        // 清除删除状态\r\n        row.deleting = false\r\n      }\r\n    },\r\n\r\n    // 分页切换\r\n    handleCurrentChange(pageNum) {\r\n      this.pageNum = pageNum\r\n      this.load()\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n/* 可以添加一些自定义样式 */\r\n.el-table {\r\n  margin-top: 10px;\r\n}\r\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}