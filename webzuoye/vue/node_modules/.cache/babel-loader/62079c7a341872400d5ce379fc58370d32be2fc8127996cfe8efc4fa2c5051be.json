{"ast":null,"code":"import bookApi from '@/api/book';\nexport default {\n  name: \"BorrowRecord\",\n  data() {\n    return {\n      // 表格数据\n      tableData: [],\n      loading: false,\n      pageNum: 1,\n      pageSize: 10,\n      total: 0,\n      // 搜索条件\n      searchBookName: '',\n      searchStudent: '',\n      searchStatus: '',\n      searchDateRange: [],\n      // 选中项\n      selectedIds: [],\n      // 统计信息\n      stats: {\n        todayBorrow: 0,\n        todayReturn: 0,\n        borrowing: 0,\n        overdue: 0\n      },\n      // 对话框\n      detailDialogVisible: false,\n      currentRecord: null,\n      // 当前登录管理员信息\n      currentAdmin: JSON.parse(localStorage.getItem('xm-user') || '{}')\n    };\n  },\n  created() {\n    // 页面加载时，获取借阅记录列表和统计信息\n    this.load(1);\n    this.loadStats();\n  },\n  methods: {\n    // 加载借阅记录列表\n    async load(pageNum) {\n      if (pageNum) this.pageNum = pageNum;\n      this.loading = true;\n      const params = {\n        pageNum: this.pageNum,\n        pageSize: this.pageSize\n      };\n\n      // 添加可选查询条件\n      if (this.searchBookName) params.bookName = this.searchBookName;\n      if (this.searchStudent) params.studentInfo = this.searchStudent;\n      if (this.searchStatus) params.status = this.searchStatus;\n      if (this.searchDateRange && this.searchDateRange.length === 2) {\n        params.startDate = this.searchDateRange[0];\n        params.endDate = this.searchDateRange[1];\n      }\n      try {\n        const res = await this.$request.get('/book/borrow/selectPage', {\n          params\n        });\n        if (res.code === '200') {\n          this.tableData = res.data?.list || [];\n          this.total = res.data?.total || 0;\n        } else {\n          this.$message.error(res.msg || '获取借阅记录失败');\n        }\n      } catch (error) {\n        console.error('加载借阅记录出错:', error);\n        this.$message.error('请求失败');\n      } finally {\n        this.loading = false;\n      }\n    },\n    // 加载统计信息（这里需要后端提供对应接口，暂时模拟数据）\n    loadStats() {\n      // 实际开发中应调用专门的统计接口\n      // 这里模拟统计数据\n      this.stats = {\n        todayBorrow: 12,\n        todayReturn: 8,\n        borrowing: 156,\n        overdue: 7\n      };\n    },\n    // 重置搜索条件\n    resetSearch() {\n      this.searchBookName = '';\n      this.searchStudent = '';\n      this.searchStatus = '';\n      this.searchDateRange = [];\n      this.load(1);\n    },\n    // 表格多选\n    handleSelectionChange(rows) {\n      this.selectedIds = rows.filter(row => row.status === 'BORROWED' || row.status === 'OVERDUE').map(row => row.id);\n    },\n    // 分页切换\n    handleCurrentChange(pageNum) {\n      this.load(pageNum);\n    },\n    // 每页条数切换\n    handleSizeChange(pageSize) {\n      this.pageSize = pageSize;\n      this.load(1);\n    },\n    // 办理归还（单条）\n    async handleReturn(record) {\n      if (!record.id) {\n        this.$message.warning('无效的记录ID');\n        return;\n      }\n      try {\n        // 确认是否要归还\n        await this.$confirm(`确认归还图书《${record.bookName}》吗？`, '办理归还', {\n          confirmButtonText: '确认归还',\n          cancelButtonText: '取消',\n          type: 'warning'\n        });\n\n        // 获取当前管理员ID（从登录信息获取）\n        const user = JSON.parse(localStorage.getItem(\"xm-user\") || '{}');\n        const adminId = user.id;\n        if (!adminId) {\n          this.$message.error('无法获取管理员信息，请重新登录');\n          return;\n        }\n        console.log('归还参数:', {\n          borrowId: record.id,\n          adminId: adminId\n        });\n\n        // 调用归还接口\n        const res = await this.$request.post(`/book/return/${record.id}`, null, {\n          params: {\n            adminId\n          }\n        });\n        console.log('归还响应:', res);\n        if (res.code === '200') {\n          this.$message.success('归还成功');\n          // 刷新列表\n          this.load(1);\n          // 重新加载统计信息\n          this.loadStats();\n          // 如果详情对话框打开，关闭它\n          if (this.detailDialogVisible) {\n            this.detailDialogVisible = false;\n          }\n        } else {\n          this.$message.error(res.msg || '归还失败');\n        }\n      } catch (error) {\n        console.log('取消操作或操作失败:', error);\n        // 如果是用户取消操作，不做处理\n        if (error !== 'cancel' && error.message !== 'cancel') {\n          this.$message.error('操作失败: ' + (error.message || '未知错误'));\n        }\n      }\n    },\n    // 批量归还\n    async handleBatchReturn() {\n      if (this.selectedIds.length === 0) {\n        this.$message.warning('请选择要归还的记录');\n        return;\n      }\n      try {\n        await this.$confirm(`确认批量归还 ${this.selectedIds.length} 条借阅记录吗？`, '批量归还', {\n          confirmButtonText: '确认归还',\n          cancelButtonText: '取消',\n          type: 'warning'\n        });\n\n        // 获取当前管理员ID\n        const user = JSON.parse(localStorage.getItem(\"xm-user\") || '{}');\n        const adminId = user.id;\n        if (!adminId) {\n          this.$message.error('无法获取管理员信息');\n          return;\n        }\n        let successCount = 0;\n        let failCount = 0;\n\n        // 逐个处理归还\n        for (const borrowId of this.selectedIds) {\n          try {\n            const res = await this.$request.post(`/book/return/${borrowId}`, null, {\n              params: {\n                adminId\n              }\n            });\n            if (res.code === '200') {\n              successCount++;\n            } else {\n              failCount++;\n              console.error(`归还记录 ${borrowId} 失败:`, res.msg);\n            }\n          } catch (error) {\n            failCount++;\n            console.error(`归还记录 ${borrowId} 异常:`, error);\n          }\n        }\n\n        // 显示处理结果\n        let message = '';\n        if (successCount > 0) {\n          message += `成功归还 ${successCount} 条记录`;\n        }\n        if (failCount > 0) {\n          message += `，失败 ${failCount} 条记录`;\n        }\n        if (message) {\n          this.$message.success(message);\n        }\n\n        // 刷新数据\n        this.load(1);\n        this.loadStats();\n        this.selectedIds = [];\n      } catch (error) {\n        console.log('取消批量归还操作');\n      }\n    },\n    // 查看详情\n    viewDetails(record) {\n      this.currentRecord = JSON.parse(JSON.stringify(record));\n      this.detailDialogVisible = true;\n    },\n    // 导出数据\n    exportData() {\n      this.$message.info('导出功能开发中...');\n      // 实际开发中可以调用后端导出接口或前端导出\n    },\n\n    // 显示统计信息\n    showStatistics() {\n      this.$alert(`借阅统计信息：\\n\\n` + `今日借阅：${this.stats.todayBorrow} 本\\n` + `今日归还：${this.stats.todayReturn} 本\\n` + `当前借阅中：${this.stats.borrowing} 本\\n` + `已超期：${this.stats.overdue} 本`, '借阅统计', {\n        confirmButtonText: '知道了',\n        callback: () => {}\n      });\n    },\n    // 工具方法：格式化日期\n    formatDate(dateStr) {\n      if (!dateStr) return '--';\n      try {\n        const date = new Date(dateStr);\n        return date.toLocaleString('zh-CN', {\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit'\n        }).replace(/\\//g, '-');\n      } catch (e) {\n        return dateStr;\n      }\n    },\n    // 工具方法：获取状态标签类型\n    getStatusTagType(status) {\n      switch (status) {\n        case 'BORROWED':\n          return 'warning';\n        case 'RETURNED':\n          return 'success';\n        case 'OVERDUE':\n          return 'danger';\n        default:\n          return 'info';\n      }\n    },\n    // 工具方法：获取状态文本\n    getStatusText(status) {\n      switch (status) {\n        case 'BORROWED':\n          return '借阅中';\n        case 'RETURNED':\n          return '已归还';\n        case 'OVERDUE':\n          return '已超期';\n        default:\n          return '未知状态';\n      }\n    },\n    // 判断是否超期（示例逻辑）\n    isOverdue(record) {\n      if (!record.dueTime || record.returnTime) return false;\n      const dueDate = new Date(record.dueTime);\n      const now = new Date();\n      return now > dueDate;\n    },\n    // 计算超期天数\n    calculateOverdueDays(record) {\n      if (!this.isOverdue(record)) return 0;\n      const dueDate = new Date(record.dueTime);\n      const now = new Date();\n      const diffTime = Math.abs(now - dueDate);\n      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n    }\n  }\n};","map":{"version":3,"names":["bookApi","name","data","tableData","loading","pageNum","pageSize","total","searchBookName","searchStudent","searchStatus","searchDateRange","selectedIds","stats","todayBorrow","todayReturn","borrowing","overdue","detailDialogVisible","currentRecord","currentAdmin","JSON","parse","localStorage","getItem","created","load","loadStats","methods","params","bookName","studentInfo","status","length","startDate","endDate","res","$request","get","code","list","$message","error","msg","console","resetSearch","handleSelectionChange","rows","filter","row","map","id","handleCurrentChange","handleSizeChange","handleReturn","record","warning","$confirm","confirmButtonText","cancelButtonText","type","user","adminId","log","borrowId","post","success","message","handleBatchReturn","successCount","failCount","viewDetails","stringify","exportData","info","showStatistics","$alert","callback","formatDate","dateStr","date","Date","toLocaleString","year","month","day","hour","minute","replace","e","getStatusTagType","getStatusText","isOverdue","dueTime","returnTime","dueDate","now","calculateOverdueDays","diffTime","Math","abs","ceil"],"sources":["src/views/manager/BorrowRecord.vue"],"sourcesContent":["<template>\r\n  <div>\r\n    <!-- 1. 搜索区 -->\r\n    <div class=\"search\">\r\n      <el-input placeholder=\"请输入图书名称\" style=\"width: 200px\" v-model=\"searchBookName\"></el-input>\r\n      <el-input placeholder=\"请输入学生姓名/ID\" style=\"width: 200px; margin-left: 10px\" v-model=\"searchStudent\"></el-input>\r\n      <el-select v-model=\"searchStatus\" placeholder=\"借阅状态\" clearable style=\"width: 120px; margin-left: 10px\">\r\n        <el-option label=\"全部\" value=\"\"></el-option>\r\n        <el-option label=\"借阅中\" value=\"BORROWED\"></el-option>\r\n        <el-option label=\"已归还\" value=\"RETURNED\"></el-option>\r\n        <el-option label=\"已超期\" value=\"OVERDUE\"></el-option>\r\n      </el-select>\r\n\r\n      <!-- 日期范围选择 -->\r\n      <el-date-picker\r\n          v-model=\"searchDateRange\"\r\n          type=\"daterange\"\r\n          range-separator=\"至\"\r\n          start-placeholder=\"开始日期\"\r\n          end-placeholder=\"结束日期\"\r\n          value-format=\"yyyy-MM-dd\"\r\n          style=\"width: 300px; margin-left: 10px\">\r\n      </el-date-picker>\r\n\r\n      <el-button type=\"info\" plain style=\"margin-left: 10px\" @click=\"load(1)\">查询</el-button>\r\n      <el-button type=\"warning\" plain style=\"margin-left: 10px\" @click=\"resetSearch\">重置</el-button>\r\n    </div>\r\n\r\n    <!-- 2. 操作按钮区 -->\r\n    <div class=\"operation\" style=\"margin-top: 15px; margin-bottom: 10px\">\r\n      <el-button type=\"primary\" plain @click=\"load(1)\" icon=\"el-icon-refresh\">刷新</el-button>\r\n      <el-button type=\"success\" plain @click=\"handleBatchReturn\" :disabled=\"selectedIds.length === 0\">\r\n        批量归还({{ selectedIds.length }})\r\n      </el-button>\r\n      <el-button type=\"warning\" plain @click=\"exportData\">导出数据</el-button>\r\n      <el-button type=\"info\" plain @click=\"showStatistics\">借阅统计</el-button>\r\n    </div>\r\n\r\n    <!-- 3. 统计信息卡片 -->\r\n    <div class=\"stat-cards\" style=\"margin-bottom: 20px; display: flex; gap: 15px;\">\r\n      <el-card shadow=\"hover\" style=\"flex: 1; text-align: center;\">\r\n        <div style=\"color: #909399; font-size: 14px;\">今日借阅</div>\r\n        <div style=\"font-size: 24px; font-weight: bold; color: #409EFF; margin-top: 10px;\">{{ stats.todayBorrow }}</div>\r\n      </el-card>\r\n      <el-card shadow=\"hover\" style=\"flex: 1; text-align: center;\">\r\n        <div style=\"color: #909399; font-size: 14px;\">今日归还</div>\r\n        <div style=\"font-size: 24px; font-weight: bold; color: #67C23A; margin-top: 10px;\">{{ stats.todayReturn }}</div>\r\n      </el-card>\r\n      <el-card shadow=\"hover\" style=\"flex: 1; text-align: center;\">\r\n        <div style=\"color: #909399; font-size: 14px;\">借阅中</div>\r\n        <div style=\"font-size: 24px; font-weight: bold; color: #E6A23C; margin-top: 10px;\">{{ stats.borrowing }}</div>\r\n      </el-card>\r\n      <el-card shadow=\"hover\" style=\"flex: 1; text-align: center;\">\r\n        <div style=\"color: #909399; font-size: 14px;\">已超期</div>\r\n        <div style=\"font-size: 24px; font-weight: bold; color: #F56C6C; margin-top: 10px;\">{{ stats.overdue }}</div>\r\n      </el-card>\r\n    </div>\r\n\r\n    <!-- 4. 借阅记录表格 -->\r\n    <div class=\"table\">\r\n      <el-table\r\n          :data=\"tableData\"\r\n          stripe\r\n          @selection-change=\"handleSelectionChange\"\r\n          v-loading=\"loading\">\r\n\r\n        <el-table-column type=\"selection\" width=\"55\" align=\"center\"></el-table-column>\r\n\r\n        <el-table-column prop=\"id\" label=\"记录ID\" width=\"90\" align=\"center\" sortable></el-table-column>\r\n\r\n        <!-- 图书信息列 -->\r\n        <el-table-column label=\"图书信息\" min-width=\"180\">\r\n          <template v-slot=\"scope\">\r\n            <div style=\"display: flex; align-items: center;\">\r\n              <div>\r\n                <div style=\"font-weight: 500;\">{{ scope.row.bookName }}</div>\r\n                <div style=\"font-size: 12px; color: #909399;\">\r\n                  {{ scope.row.bookAuthor }} | ISBN: {{ scope.row.bookIsbn }}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 学生信息列 -->\r\n        <el-table-column label=\"借阅学生\" width=\"150\">\r\n          <template v-slot=\"scope\">\r\n            <div>\r\n              <div>{{ scope.row.userName }}</div>\r\n              <div style=\"font-size: 12px; color: #909399;\">ID: {{ scope.row.userId }}</div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 时间信息列 -->\r\n        <el-table-column label=\"借阅时间\" width=\"160\" align=\"center\">\r\n          <template v-slot=\"scope\">\r\n            <div>\r\n              <div>{{ formatDate(scope.row.borrowTime) }}</div>\r\n              <div style=\"font-size: 12px; color: #909399;\">\r\n                应还: {{ formatDate(scope.row.dueTime) }}\r\n              </div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 归还时间列 -->\r\n        <el-table-column label=\"归还时间\" width=\"160\" align=\"center\">\r\n          <template v-slot=\"scope\">\r\n            <div v-if=\"scope.row.returnTime\">\r\n              {{ formatDate(scope.row.returnTime) }}\r\n            </div>\r\n            <div v-else style=\"color: #F56C6C;\">--</div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 状态列 -->\r\n        <el-table-column label=\"状态\" width=\"100\" align=\"center\">\r\n          <template v-slot=\"scope\">\r\n            <el-tag\r\n                :type=\"getStatusTagType(scope.row.status)\"\r\n                size=\"small\"\r\n                effect=\"dark\">\r\n              {{ getStatusText(scope.row.status) }}\r\n            </el-tag>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 管理员列 -->\r\n        <el-table-column label=\"操作员\" width=\"120\">\r\n          <template v-slot=\"scope\">\r\n            <div>\r\n              <div>{{ scope.row.adminName || '--' }}</div>\r\n              <div style=\"font-size: 12px; color: #909399;\">ID: {{ scope.row.adminId }}</div>\r\n            </div>\r\n          </template>\r\n        </el-table-column>\r\n\r\n        <!-- 操作列 -->\r\n        <el-table-column label=\"操作\" width=\"150\" align=\"center\" fixed=\"right\">\r\n          <template v-slot=\"scope\">\r\n            <el-button\r\n                v-if=\"scope.row.status === 'BORROWED' || scope.row.status === 'OVERDUE'\"\r\n                type=\"success\"\r\n                size=\"mini\"\r\n                plain\r\n                @click=\"handleReturn(scope.row)\">\r\n              办理归还\r\n            </el-button>\r\n            <span v-else style=\"color: #909399;\">已归还</span>\r\n\r\n            <el-button\r\n                type=\"info\"\r\n                size=\"mini\"\r\n                plain\r\n                style=\"margin-top: 5px;\"\r\n                @click=\"viewDetails(scope.row)\">\r\n              详情\r\n            </el-button>\r\n          </template>\r\n        </el-table-column>\r\n      </el-table>\r\n\r\n      <!-- 分页 -->\r\n      <div class=\"pagination\" style=\"margin-top: 15px\">\r\n        <el-pagination\r\n            background\r\n            @current-change=\"handleCurrentChange\"\r\n            @size-change=\"handleSizeChange\"\r\n            :current-page=\"pageNum\"\r\n            :page-sizes=\"[10, 20, 50, 100]\"\r\n            :page-size=\"pageSize\"\r\n            layout=\"total, sizes, prev, pager, next, jumper\"\r\n            :total=\"total\">\r\n        </el-pagination>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 5. 借阅详情对话框 -->\r\n    <el-dialog\r\n        title=\"借阅记录详情\"\r\n        :visible.sync=\"detailDialogVisible\"\r\n        width=\"50%\"\r\n        :close-on-click-modal=\"false\">\r\n\r\n      <div v-if=\"currentRecord\" style=\"line-height: 1.8;\">\r\n        <el-descriptions :column=\"2\" border>\r\n          <el-descriptions-item label=\"借阅编号\">{{ currentRecord.id }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"借阅状态\">\r\n            <el-tag :type=\"getStatusTagType(currentRecord.status)\" size=\"small\">\r\n              {{ getStatusText(currentRecord.status) }}\r\n            </el-tag>\r\n          </el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"图书名称\">{{ currentRecord.bookName }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"图书作者\">{{ currentRecord.bookAuthor }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"ISBN\">{{ currentRecord.bookIsbn }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"馆藏位置\">{{ currentRecord.bookLocation || '--' }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"借阅学生\">{{ currentRecord.userName }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"学生ID\">{{ currentRecord.userId }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"借阅时间\">{{ formatDate(currentRecord.borrowTime) }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"应还时间\">{{ formatDate(currentRecord.dueTime) }}</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"实际归还时间\" v-if=\"currentRecord.returnTime\">\r\n            {{ formatDate(currentRecord.returnTime) }}\r\n          </el-descriptions-item>\r\n          <el-descriptions-item label=\"实际归还时间\" v-else>--</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"超期天数\" v-if=\"isOverdue(currentRecord)\">\r\n            <span style=\"color: #F56C6C; font-weight: bold;\">{{ calculateOverdueDays(currentRecord) }} 天</span>\r\n          </el-descriptions-item>\r\n          <el-descriptions-item label=\"超期天数\" v-else>0 天</el-descriptions-item>\r\n\r\n          <el-descriptions-item label=\"操作管理员\">{{ currentRecord.adminName || '--' }}</el-descriptions-item>\r\n          <el-descriptions-item label=\"管理员ID\">{{ currentRecord.adminId }}</el-descriptions-item>\r\n        </el-descriptions>\r\n\r\n        <!-- 备注信息 -->\r\n        <div style=\"margin-top: 20px;\">\r\n          <h4 style=\"color: #606266; margin-bottom: 10px;\">备注信息</h4>\r\n          <el-input\r\n              type=\"textarea\"\r\n              :rows=\"3\"\r\n              placeholder=\"暂无备注信息\"\r\n              v-model=\"currentRecord.remark\"\r\n              disabled>\r\n          </el-input>\r\n        </div>\r\n      </div>\r\n\r\n      <div slot=\"footer\" class=\"dialog-footer\">\r\n        <el-button @click=\"detailDialogVisible = false\">关闭</el-button>\r\n        <el-button\r\n            v-if=\"currentRecord && (currentRecord.status === 'BORROWED' || currentRecord.status === 'OVERDUE')\"\r\n            type=\"primary\"\r\n            @click=\"handleReturn(currentRecord)\">\r\n          办理归还\r\n        </el-button>\r\n      </div>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport bookApi from '@/api/book'\r\n\r\nexport default {\r\n  name: \"BorrowRecord\",\r\n  data() {\r\n    return {\r\n      // 表格数据\r\n      tableData: [],\r\n      loading: false,\r\n      pageNum: 1,\r\n      pageSize: 10,\r\n      total: 0,\r\n\r\n      // 搜索条件\r\n      searchBookName: '',\r\n      searchStudent: '',\r\n      searchStatus: '',\r\n      searchDateRange: [],\r\n\r\n      // 选中项\r\n      selectedIds: [],\r\n\r\n      // 统计信息\r\n      stats: {\r\n        todayBorrow: 0,\r\n        todayReturn: 0,\r\n        borrowing: 0,\r\n        overdue: 0\r\n      },\r\n\r\n      // 对话框\r\n      detailDialogVisible: false,\r\n      currentRecord: null,\r\n\r\n      // 当前登录管理员信息\r\n      currentAdmin: JSON.parse(localStorage.getItem('xm-user') || '{}')\r\n    }\r\n  },\r\n  created() {\r\n    // 页面加载时，获取借阅记录列表和统计信息\r\n    this.load(1)\r\n    this.loadStats()\r\n  },\r\n  methods: {\r\n    // 加载借阅记录列表\r\n    async load(pageNum) {\r\n      if (pageNum) this.pageNum = pageNum\r\n      this.loading = true\r\n\r\n      const params = {\r\n        pageNum: this.pageNum,\r\n        pageSize: this.pageSize\r\n      }\r\n\r\n      // 添加可选查询条件\r\n      if (this.searchBookName) params.bookName = this.searchBookName\r\n      if (this.searchStudent) params.studentInfo = this.searchStudent\r\n      if (this.searchStatus) params.status = this.searchStatus\r\n      if (this.searchDateRange && this.searchDateRange.length === 2) {\r\n        params.startDate = this.searchDateRange[0]\r\n        params.endDate = this.searchDateRange[1]\r\n      }\r\n\r\n      try {\r\n        const res = await this.$request.get('/book/borrow/selectPage', { params })\r\n        if (res.code === '200') {\r\n          this.tableData = res.data?.list || []\r\n          this.total = res.data?.total || 0\r\n        } else {\r\n          this.$message.error(res.msg || '获取借阅记录失败')\r\n        }\r\n      } catch (error) {\r\n        console.error('加载借阅记录出错:', error)\r\n        this.$message.error('请求失败')\r\n      } finally {\r\n        this.loading = false\r\n      }\r\n    },\r\n\r\n    // 加载统计信息（这里需要后端提供对应接口，暂时模拟数据）\r\n    loadStats() {\r\n      // 实际开发中应调用专门的统计接口\r\n      // 这里模拟统计数据\r\n      this.stats = {\r\n        todayBorrow: 12,\r\n        todayReturn: 8,\r\n        borrowing: 156,\r\n        overdue: 7\r\n      }\r\n    },\r\n\r\n    // 重置搜索条件\r\n    resetSearch() {\r\n      this.searchBookName = ''\r\n      this.searchStudent = ''\r\n      this.searchStatus = ''\r\n      this.searchDateRange = []\r\n      this.load(1)\r\n    },\r\n\r\n    // 表格多选\r\n    handleSelectionChange(rows) {\r\n      this.selectedIds = rows\r\n          .filter(row => row.status === 'BORROWED' || row.status === 'OVERDUE')\r\n          .map(row => row.id)\r\n    },\r\n\r\n    // 分页切换\r\n    handleCurrentChange(pageNum) {\r\n      this.load(pageNum)\r\n    },\r\n\r\n    // 每页条数切换\r\n    handleSizeChange(pageSize) {\r\n      this.pageSize = pageSize\r\n      this.load(1)\r\n    },\r\n\r\n    // 办理归还（单条）\r\n    async handleReturn(record) {\r\n      if (!record.id) {\r\n        this.$message.warning('无效的记录ID')\r\n        return\r\n      }\r\n\r\n      try {\r\n        // 确认是否要归还\r\n        await this.$confirm(`确认归还图书《${record.bookName}》吗？`, '办理归还', {\r\n          confirmButtonText: '确认归还',\r\n          cancelButtonText: '取消',\r\n          type: 'warning'\r\n        })\r\n\r\n        // 获取当前管理员ID（从登录信息获取）\r\n        const user = JSON.parse(localStorage.getItem(\"xm-user\") || '{}')\r\n        const adminId = user.id\r\n\r\n        if (!adminId) {\r\n          this.$message.error('无法获取管理员信息，请重新登录')\r\n          return\r\n        }\r\n\r\n        console.log('归还参数:', {\r\n          borrowId: record.id,\r\n          adminId: adminId\r\n        })\r\n\r\n        // 调用归还接口\r\n        const res = await this.$request.post(`/book/return/${record.id}`, null, {\r\n          params: { adminId }\r\n        })\r\n\r\n        console.log('归还响应:', res)\r\n\r\n        if (res.code === '200') {\r\n          this.$message.success('归还成功')\r\n          // 刷新列表\r\n          this.load(1)\r\n          // 重新加载统计信息\r\n          this.loadStats()\r\n          // 如果详情对话框打开，关闭它\r\n          if (this.detailDialogVisible) {\r\n            this.detailDialogVisible = false\r\n          }\r\n        } else {\r\n          this.$message.error(res.msg || '归还失败')\r\n        }\r\n      } catch (error) {\r\n        console.log('取消操作或操作失败:', error)\r\n        // 如果是用户取消操作，不做处理\r\n        if (error !== 'cancel' && error.message !== 'cancel') {\r\n          this.$message.error('操作失败: ' + (error.message || '未知错误'))\r\n        }\r\n      }\r\n    },\r\n\r\n    // 批量归还\r\n    async handleBatchReturn() {\r\n      if (this.selectedIds.length === 0) {\r\n        this.$message.warning('请选择要归还的记录')\r\n        return\r\n      }\r\n\r\n      try {\r\n        await this.$confirm(`确认批量归还 ${this.selectedIds.length} 条借阅记录吗？`, '批量归还', {\r\n          confirmButtonText: '确认归还',\r\n          cancelButtonText: '取消',\r\n          type: 'warning'\r\n        })\r\n\r\n        // 获取当前管理员ID\r\n        const user = JSON.parse(localStorage.getItem(\"xm-user\") || '{}')\r\n        const adminId = user.id\r\n\r\n        if (!adminId) {\r\n          this.$message.error('无法获取管理员信息')\r\n          return\r\n        }\r\n\r\n        let successCount = 0\r\n        let failCount = 0\r\n\r\n        // 逐个处理归还\r\n        for (const borrowId of this.selectedIds) {\r\n          try {\r\n            const res = await this.$request.post(`/book/return/${borrowId}`, null, {\r\n              params: { adminId }\r\n            })\r\n\r\n            if (res.code === '200') {\r\n              successCount++\r\n            } else {\r\n              failCount++\r\n              console.error(`归还记录 ${borrowId} 失败:`, res.msg)\r\n            }\r\n          } catch (error) {\r\n            failCount++\r\n            console.error(`归还记录 ${borrowId} 异常:`, error)\r\n          }\r\n        }\r\n\r\n        // 显示处理结果\r\n        let message = ''\r\n        if (successCount > 0) {\r\n          message += `成功归还 ${successCount} 条记录`\r\n        }\r\n        if (failCount > 0) {\r\n          message += `，失败 ${failCount} 条记录`\r\n        }\r\n\r\n        if (message) {\r\n          this.$message.success(message)\r\n        }\r\n\r\n        // 刷新数据\r\n        this.load(1)\r\n        this.loadStats()\r\n        this.selectedIds = []\r\n\r\n      } catch (error) {\r\n        console.log('取消批量归还操作')\r\n      }\r\n    },\r\n\r\n    // 查看详情\r\n    viewDetails(record) {\r\n      this.currentRecord = JSON.parse(JSON.stringify(record))\r\n      this.detailDialogVisible = true\r\n    },\r\n\r\n    // 导出数据\r\n    exportData() {\r\n      this.$message.info('导出功能开发中...')\r\n      // 实际开发中可以调用后端导出接口或前端导出\r\n    },\r\n\r\n    // 显示统计信息\r\n    showStatistics() {\r\n      this.$alert(\r\n          `借阅统计信息：\\n\\n` +\r\n          `今日借阅：${this.stats.todayBorrow} 本\\n` +\r\n          `今日归还：${this.stats.todayReturn} 本\\n` +\r\n          `当前借阅中：${this.stats.borrowing} 本\\n` +\r\n          `已超期：${this.stats.overdue} 本`,\r\n          '借阅统计',\r\n          {\r\n            confirmButtonText: '知道了',\r\n            callback: () => {}\r\n          }\r\n      )\r\n    },\r\n\r\n    // 工具方法：格式化日期\r\n    formatDate(dateStr) {\r\n      if (!dateStr) return '--'\r\n      try {\r\n        const date = new Date(dateStr)\r\n        return date.toLocaleString('zh-CN', {\r\n          year: 'numeric',\r\n          month: '2-digit',\r\n          day: '2-digit',\r\n          hour: '2-digit',\r\n          minute: '2-digit'\r\n        }).replace(/\\//g, '-')\r\n      } catch (e) {\r\n        return dateStr\r\n      }\r\n    },\r\n\r\n    // 工具方法：获取状态标签类型\r\n    getStatusTagType(status) {\r\n      switch (status) {\r\n        case 'BORROWED': return 'warning'\r\n        case 'RETURNED': return 'success'\r\n        case 'OVERDUE': return 'danger'\r\n        default: return 'info'\r\n      }\r\n    },\r\n\r\n    // 工具方法：获取状态文本\r\n    getStatusText(status) {\r\n      switch (status) {\r\n        case 'BORROWED': return '借阅中'\r\n        case 'RETURNED': return '已归还'\r\n        case 'OVERDUE': return '已超期'\r\n        default: return '未知状态'\r\n      }\r\n    },\r\n\r\n    // 判断是否超期（示例逻辑）\r\n    isOverdue(record) {\r\n      if (!record.dueTime || record.returnTime) return false\r\n\r\n      const dueDate = new Date(record.dueTime)\r\n      const now = new Date()\r\n      return now > dueDate\r\n    },\r\n\r\n    // 计算超期天数\r\n    calculateOverdueDays(record) {\r\n      if (!this.isOverdue(record)) return 0\r\n\r\n      const dueDate = new Date(record.dueTime)\r\n      const now = new Date()\r\n      const diffTime = Math.abs(now - dueDate)\r\n      return Math.ceil(diffTime / (1000 * 60 * 60 * 24))\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.search, .operation {\r\n  margin-bottom: 15px;\r\n}\r\n\r\n.stat-cards .el-card:hover {\r\n  transform: translateY(-2px);\r\n  transition: transform 0.3s;\r\n}\r\n\r\n/* 状态标签样式 */\r\n.el-tag {\r\n  margin: 2px;\r\n}\r\n\r\n/* 表格行悬停效果 */\r\n.el-table >>> .hover-row {\r\n  cursor: pointer;\r\n  transition: background-color 0.3s;\r\n}\r\n\r\n.el-table >>> .hover-row:hover {\r\n  background-color: #f5f7fa !important;\r\n}\r\n</style>"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}